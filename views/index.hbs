{{#if currentActivity}}
  <div class="current-activity-card">
    <h2>ðŸŽ¯ Current Activity</h2>
    <p class="time">{{currentActivity.startTime}} - {{currentActivity.endTime}}</p>
    <h3>{{currentActivity.activity}}</h3>

    {{#if activeSession}}
      <div class="session-form">
        <h4>Session in Progress</h4>
        <p class="session-start">Started at: {{activeSession.actualStartTime}}</p>
        <form method="POST" action="/timetable/sessions/{{activeSession.id}}/complete">
          <textarea name="learnings" placeholder="What did you learn?" required></textarea>
          <textarea name="notes" placeholder="Additional notes (optional)"></textarea>
          <button type="submit" class="btn btn-success">Complete Session</button>
        </form>
      </div>
    {{else}}
      <form method="POST" action="/timetable/sessions/start/{{currentActivity.id}}" style="margin-top:15px;">
        <button type="submit" class="btn btn-success">Start Session</button>
      </form>
    {{/if}}
  </div>
{{/if}}

<div class="card">
  <h3>Today's Completed Sessions</h3>
  {{#each todaysSessions}}
    {{#if this.completed}}
      <div class="session-card">
        <p class="time">{{this.actualStartTime}} - {{this.actualEndTime}}</p>
        <strong>{{this.activity.activity}}</strong>
        {{#if this.learnings}}<p class="learnings"><em>Learnings: {{this.learnings}}</em></p>{{/if}}
      </div>
    {{/if}}
  {{/each}}
</div>

<div class="timetable-header">
  <h2>Weekly Timetable</h2>
  <button type="button" class="btn btn-primary" onclick="openModal()">+ Add Activity</button>
</div>

<table>
  <thead>
  <tr>
    <th>Day</th>
    <th>Activities</th>
  </tr>
  </thead>
  <tbody>
  {{#each days}}
    <tr>
      <td><strong>{{this}}</strong></td>
      <td>
        <div class="activities-container">
          {{#with (lookup ../timetable this)}}
            {{#each this}}
              <div class="activity-card">
                <p class="time">{{this.startTime}} - {{this.endTime}}</p>
                <strong>{{this.activity}}</strong>
              </div>
            {{/each}}
          {{else}}
            <p class="no-activity">No activities</p>
          {{/with}}
        </div>
      </td>
    </tr>
  {{/each}}
  </tbody>
</table>

<!-- Modal -->
<div id="activityModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add New Activity</h2>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <form method="POST" action="/timetable/activities">
      <div class="grid">
        <div>
          <label>Day</label>
          <select name="day" required>
            {{#each days}}
              <option value="{{this}}">{{this}}</option>
            {{/each}}
          </select>
        </div>
        <div>
          <label>Start Time</label>
          <input type="time" name="startTime" required>
        </div>
        <div>
          <label>End Time</label>
          <input type="time" name="endTime" required>
        </div>
      </div>
      <div style="margin-top:15px;">
        <label>Activity</label>
        <input type="text" name="activity" placeholder="What will you be doing?" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Activity</button>
      </div>
    </form>
  </div>
</div>

<script>
  function openModal() {
    document.getElementById('activityModal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('activityModal').style.display = 'none';
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('activityModal');
    if (event.target === modal) {
      closeModal();
    }
  }

  // Close modal on Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeModal();
    }
  });
</script>